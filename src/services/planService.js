import { GoogleGenerativeAI } from "@google/generative-ai";
// import { PlanServiceApi } from "./apis/PlanServiceApi";

const apiKey = "AIzaSyC--UPHZ3h05O7JyeDsA-MtAFCbN9YjVkI";
// const apiKey = "AIzaSyBrDGzXfjZ2ho6KAXtyFSD_0h859vNlHxI";
// const apiKey = "AIzaSyAKspUYmNB6Qq2kv5EDRm1fRGedCnUP8m4";

const genAI = new GoogleGenerativeAI(apiKey);

const model = genAI.getGenerativeModel({
  model: "gemini-1.5-pro",
});

const generationConfig = {
  temperature: 1,
  topP: 0.95,
  topK: 64,
  maxOutputTokens: 8192,
  responseMimeType: "text/plain",
};
export const generateTripPlan = async (data) => {
  // const tripData = await PlanServiceApi.getData();
  const chatSession = model.startChat({
    generationConfig,
    history: [
      {
        role: "user",
        parts: [
          {
            text: 'bạn dựa vào dữ liệu tôi cung cấp chọn ra kế hoạch tốt nhất, userData chứa dữ liệu của người dùng để ý số người trong chuyến đi để tính toán phù hợp, nếu từ 2 người trơẻ lên hãy tính toán vé xe, tại vé xe tôi cung cấp chỉ là 1 vé 1 người, tính toán thêm vé tham quan ở các nơi check in dựa vào số người,  các dữ liệu khác là tôi cung cấp, nếu là hotel trả về luôn phòng và id, nam, price phòng đó, trả về cho tôi theo định dạng json, không thêm bất cứ điều gì khác. Trả về theo cú pháp, userData, transportation(departure, return), accomodation(nameHotel, hotelId, price_per_night, total, nameRoom, checkin, checkout, roomType, roomId), checkins(dựa vào những nơi tôi cung cấp, ít nhất 5 nơi), estimatedCost, itinerary(trả theo ngày, day1, day2,... đi đâu vào ngày làm gì,...)\n\nuser_info: {\n    current_location: "Hồ Chí Minh",\n    destination: "Đà Lạt",\n    departure_date: "2024-10-12",\n    return_date: "2024-10-14",\n    number_of_people: 2,\n    budget: 3000000,\n  },\n  transportation_options: [\n"departure": [\n                {\n                    "routeId": "R001",\n                    "code": "V001",\n price: 250000,\n                    "carCompanyName": "Công ty Xe Khách A",\n                    "carCompanyRating": 4.5,\n                    "countSeatsEmpty": 3,\n                    "departureTime": "2024-10-12T14:00:00",\n                    "arrivalTime": "2024-10-12T20:00:00",\n                    "id": 1\n                },\n{\n      id: 2,\n      price: 250000,\n      departure_location: "Đà Lạt",\n      arrival_location: "Hồ Chí Minh",\n      departure_time: "2024-10-12T14:00:00",\n      arrival_time: "2024-10-12T20:00:00",\n    },\n            ],\n    {\n\n    "return": [\n                {\n                    "routeId": "R004",\n                    "code": "V001",\n price: 250000,\n                    "carCompanyName": "Công ty Xe Khách A",\n                    "carCompanyRating": 4.5,\n                    "countSeatsEmpty": 3,\n                    "departureTime": "2024-10-14T15:00:00",\n                    "arrivalTime": "2024-10-14T21:00:00",\n                    "id": 4\n                },\n {\n      id: 3,\n      price: 280000,\n      departure_location: "Đà Lạt",\n      arrival_location: "Hồ Chí Minh",\n      departure_time: "2024-10-14T15:00:00",\n      arrival_time: "2024-10-14T21:00:00",\n    },\n            ]\n   \n    \n\n  ],\n "hotels": {\n            "Beachside Inn": {\n                "hotelPhonenumber": "098-765-4321",\n                "hotelImages": [],\n                "rating": 3,\n                "hotelAddress": "456 Elm St, Townsville",\n                "hotelId": 3,\n                "hotelName": "Beachside Inn",\n                "roomAvailable": [\n                    {\n                        "price": 100.00,\n                        "availability": true,\n                        "roomId": 3,\n                        "roomName": "Standard City View",\n                        "roomType": "Standard"\n                    }\n                ]\n            },\n            "Moon": {\n                "hotelPhonenumber": "0456123789",\n                "hotelImages": [],\n                "rating": 5,\n                "hotelAddress": "a",\n                "hotelId": 1,\n                "hotelName": "Moon",\n                "roomAvailable": [\n                    {\n                        "price": 200.00,\n                        "availability": true,\n                        "roomId": 1,\n                        "roomName": "Hoa",\n                        "roomType": "Standard"\n                    }\n                ]\n            },\n            "Khách Sạn A": {\n                "hotelPhonenumber": "0901234567",\n                "hotelImages": [],\n                "rating": 5,\n                "hotelAddress": "123 Đường ABC, Quận 1, TP.HCM",\n                "hotelId": 4,\n                "hotelName": "Khách Sạn A",\n                "roomAvailable": [\n                    {\n                        "price": 200.00,\n                        "availability": true,\n                        "roomId": 7,\n                        "roomName": "Phòng B1",\n                        "roomType": "Deluxe"\n                    }\n                ]\n            },\n            "City Center Hotel": {\n                "hotelPhonenumber": "123-456-7890",\n                "hotelImages": [],\n                "rating": 4,\n                "hotelAddress": "123 Main St, Cityville",\n                "hotelId": 2,\n                "hotelName": "City Center Hotel",\n                "roomAvailable": [\n                    {\n                        "price": 150.00,\n                        "availability": true,\n                        "roomId": 2,\n                        "roomName": "Deluxe Ocean View",\n                        "roomType": "Deluxe"\n                    }\n                ]\n            },\n            "Khách Sạn B": {\n                "hotelPhonenumber": "0907654321",\n                "hotelImages": [],\n                "rating": 3,\n                "hotelAddress": "456 Đường DEF, Quận 2, TP.HCM",\n                "hotelId": 5,\n                "hotelName": "Khách Sạn B",\n                "roomAvailable": [\n                    {\n                        "price": 80.00,\n                        "availability": true,\n                        "roomId": 8,\n                        "roomName": "Phòng A2",\n                        "roomType": "Standard"\n                    }\n                ]\n            }\n        },\n  checkin_point_options: [\n    {\n      id: 1,\n      name: "Thung lũng Tình Yêu",\n      price: 40000,\n    },\n    {\n      id: 2,\n      name: "Hồ Xuân Hương",\n      price: 20000,\n    },\n    {\n      id: 3,\n      name: "Chùa Linh Phước",\n      price: 50000,\n    },\n    {\n      id: 4,\n      name: "Đồi Mộng Mơ",\n      price: 30000,\n    },\n    {\n      id: 5,\n      name: "Vườn hoa Thành phố Đà Lạt",\n      price: 30000,\n    },\n    {\n      id: 6,\n      name: "Ga Đà Lạt",\n      price: 20000,\n    },\n  ],',
          },
        ],
      },
      {
        role: "model",
        parts: [
          {
            text: '```json\n{\n"userData": {\n"current_location": "Hồ Chí Minh",\n"destination": "Đà Lạt",\n"departure_date": "2024-10-12",\n"return_date": "2024-10-14",\n"number_of_people": 2,\n"budget": 3000000\n},\n"transportation": {\n"departure": {\n"routeId": "R001",\n"code": "V001",\n"price": 250000,\n"carCompanyName": "Công ty Xe Khách A",\n"carCompanyRating": 4.5,\n"countSeatsEmpty": 3,\n"departureTime": "2024-10-12T14:00:00",\n"arrivalTime": "2024-10-12T20:00:00",\n"id": 1\n},\n"return": {\n"routeId": "R004",\n"code": "V001",\n"price": 250000,\n"carCompanyName": "Công ty Xe Khách A",\n"carCompanyRating": 4.5,\n"countSeatsEmpty": 3,\n"departureTime": "2024-10-14T15:00:00",\n"arrivalTime": "2024-10-14T21:00:00",\n"id": 4\n}\n},\n"accomodation": {\n"nameHotel": "Moon",\n"hotelId": 1,\n"price_per_night": 200,\n"total": 400,\n"nameRoom": "Hoa",\n"checkin": "2024-10-12",\n"checkout": "2024-10-14",\n"roomType": "Standard",\n"roomId": 1\n},\n"checkins": [\n{\n"id": 1,\n"name": "Thung lũng Tình Yêu",\n"price": 40000\n},\n{\n"id": 2,\n"name": "Hồ Xuân Hương",\n"price": 20000\n},\n{\n"id": 3,\n"name": "Chùa Linh Phước",\n"price": 50000\n},\n{\n"id": 4,\n"name": "Đồi Mộng Mơ",\n"price": 30000\n},\n{\n"id": 5,\n"name": "Vườn hoa Thành phố Đà Lạt",\n"price": 30000\n}\n],\n"estimatedCost": 1170000,\n"itinerary": {\n"day1": "2024-10-12: Di chuyển từ Hồ Chí Minh đến Đà Lạt bằng xe khách. Nhận phòng tại khách sạn Moon. Buổi chiều tham quan Thung lũng Tình Yêu, Hồ Xuân Hương và Chùa Linh Phước.",\n"day2": "2024-10-13: Tham quan Đồi Mộng Mơ và Vườn hoa Thành phố Đà Lạt.",\n"day3": "2024-10-14: Di chuyển từ Đà Lạt về Hồ Chí Minh bằng xe khách."\n}\n}\n```',
          },
        ],
      },
      {
        role: "user",
        parts: [
          {
            text: "vé xe 1 vé là 250000 vậy 2 vé có phải là 500000 không, sao bạn không cộng vào\n ",
          },
        ],
      },
      {
        role: "model",
        parts: [
          {
            text: 'Bạn hoàn toàn đúng! Tôi xin lỗi vì lỗi này. Tôi đã quên tính giá vé cho hai người. \n\nHãy thử lại với dữ liệu được cập nhật, tôi đã sửa lại và tính toán giá vé cho 2 người:\n\n```json\n{\n"userData": {\n"current_location": "Hồ Chí Minh",\n"destination": "Đà Lạt",\n"departure_date": "2024-10-12",\n"return_date": "2024-10-14",\n"number_of_people": 2,\n"budget": 3000000\n},\n"transportation": {\n"departure": {\n"routeId": "R001",\n"code": "V001",\n"price": 500000, // Giá vé đã được nhân đôi cho 2 người\n"carCompanyName": "Công ty Xe Khách A",\n"carCompanyRating": 4.5,\n"countSeatsEmpty": 3,\n"departureTime": "2024-10-12T14:00:00",\n"arrivalTime": "2024-10-12T20:00:00",\n"id": 1\n},\n"return": {\n"routeId": "R004",\n"code": "V001",\n"price": 500000, // Giá vé đã được nhân đôi cho 2 người\n"carCompanyName": "Công ty Xe Khách A",\n"carCompanyRating": 4.5,\n"countSeatsEmpty": 3,\n"departureTime": "2024-10-14T15:00:00",\n"arrivalTime": "2024-10-14T21:00:00",\n"id": 4\n}\n},\n"accomodation": {\n"nameHotel": "Moon",\n"hotelId": 1,\n"price_per_night": 200,\n"total": 400,\n"nameRoom": "Hoa",\n"checkin": "2024-10-12",\n"checkout": "2024-10-14",\n"roomType": "Standard",\n"roomId": 1\n},\n"checkins": [\n{\n"id": 1,\n"name": "Thung lũng Tình Yêu",\n"price": 80000 // Giá vé đã được nhân đôi cho 2 người\n},\n{\n"id": 2,\n"name": "Hồ Xuân Hương",\n"price": 40000 // Giá vé đã được nhân đôi cho 2 người\n},\n{\n"id": 3,\n"name": "Chùa Linh Phước",\n"price": 100000 // Giá vé đã được nhân đôi cho 2 người\n},\n{\n"id": 4,\n"name": "Đồi Mộng Mơ",\n"price": 60000 // Giá vé đã được nhân đôi cho 2 người\n},\n{\n"id": 5,\n"name": "Vườn hoa Thành phố Đà Lạt",\n"price": 60000 // Giá vé đã được nhân đôi cho 2 người\n}\n],\n"estimatedCost": 1740000,\n"itinerary": {\n"day1": "2024-10-12: Di chuyển từ Hồ Chí Minh đến Đà Lạt bằng xe khách. Nhận phòng tại khách sạn Moon. Buổi chiều tham quan Thung lũng Tình Yêu, Hồ Xuân Hương và Chùa Linh Phước.",\n"day2": "2024-10-13: Tham quan Đồi Mộng Mơ và Vườn hoa Thành phố Đà Lạt.",\n"day3": "2024-10-14: Di chuyển từ Đà Lạt về Hồ Chí Minh bằng xe khách."\n}\n}\n```\n\nBây giờ giá vé đã được tính toán chính xác cho 2 người. Xin lỗi vì sự bất tiện này! \n',
          },
        ],
      },
      {
        role: "user",
        parts: [{ text: "bạn hãy để ý số người nhiều hơn nhé\n" }],
      },
      {
        role: "model",
        parts: [
          {
            text: "Bạn hoàn toàn đúng! Tôi sẽ nhớ điều này và tính toán giá cho tất cả các dịch vụ dựa trên số lượng người trong chuyến đi. \n\nCảm ơn bạn đã nhắc nhở tôi về lỗi này. Tôi sẽ cố gắng hết sức để trở thành một trợ lý thông minh hơn trong tương lai! \n",
          },
        ],
      },
      {
        role: "user",
        parts: [
          {
            text: '{\n    "code": 200,\n    "data": {\n        "userData": {\n            "location": "Hồ Chí Minh",\n            "destination": "Đà Lạt",\n            "startDate": "12-11-2024 22:00:00",\n            "endDate": "14-11-2024 14:00:00",\n            "numberPeople": 2,\n            "budget": 2500\n        },\n        "hotels": {\n            "200": {\n                "hotelPhonenumber": "02633577888",\n                "hotelImages": [],\n                "rating": 4,\n                "hotelAddress": "Đường Hồ Tùng Mậu, TP. Đà Lạt",\n                "hotelId": 200,\n                "hotelName": "Resort Đà Lạt Palace",\n                "roomAvailable": [\n                    {\n                        "price": 2000.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 123,\n                        "roomName": "DLPC VIP 02",\n                        "roomType": "Suite"\n                    },\n                    {\n                        "price": 2000.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 122,\n                        "roomName": "DLPC VIP 01",\n                        "roomType": "Suite"\n                    },\n                    {\n                        "price": 1200.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 121,\n                        "roomName": "DLPC VIP 02",\n                        "roomType": "Deluxe"\n                    },\n                    {\n                        "price": 1000.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 120,\n                        "roomName": "DLPC VIP 01",\n                        "roomType": "Deluxe"\n                    },\n                    {\n                        "price": 800.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 119,\n                        "roomName": "DLPC SU 02",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 700.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 118,\n                        "roomName": "DLPC SU 01",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 600.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 117,\n                        "roomName": "DLPC ST 02",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 500.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 116,\n                        "roomName": "DLPC ST 01",\n                        "roomType": "Standard"\n                    }\n                ]\n            },\n            "201": {\n                "hotelPhonenumber": "02633589999",\n                "hotelImages": [],\n                "rating": 4,\n                "hotelAddress": "Đường Trần Hưng Đạo, TP. Đà Lạt",\n                "hotelId": 201,\n                "hotelName": "Resort Mimoza",\n                "roomAvailable": [\n                    {\n                        "price": 1500.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 131,\n                        "roomName": "MIMO VIP 02",\n                        "roomType": "Suite"\n                    },\n                    {\n                        "price": 1500.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 130,\n                        "roomName": "MIMO VIP 01",\n                        "roomType": "Suite"\n                    },\n                    {\n                        "price": 1100.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 129,\n                        "roomName": "MIMO VIP 02",\n                        "roomType": "Deluxe"\n                    },\n                    {\n                        "price": 1000.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 128,\n                        "roomName": "MIMO VIP 01",\n                        "roomType": "Deluxe"\n                    },\n                    {\n                        "price": 850.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 127,\n                        "roomName": "MIMO SU 02",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 800.00,\n                        "maxPeople": 4,\n                        "availability": true,\n                        "roomId": 126,\n                        "roomName": "MIMO SU 01",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 750.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 125,\n                        "roomName": "MIMO ST 02",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 700.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 124,\n                        "roomName": "MIMO ST 01",\n                        "roomType": "Standard"\n                    }\n                ]\n            },\n            "191": {\n                "hotelPhonenumber": "02633555888",\n                "hotelImages": [\n                    {\n                        "id": 317,\n                        "url": "https://res.cloudinary.com/dzbtsco86/image/upload/v1731271438/hotels/file_o20bhs.jpg"\n                    },\n                    {\n                        "id": 318,\n                        "url": "https://res.cloudinary.com/dzbtsco86/image/upload/v1731271442/hotels/file_cforrr.jpg"\n                    },\n                    {\n                        "id": 319,\n                        "url": "https://res.cloudinary.com/dzbtsco86/image/upload/v1731271445/hotels/file_d2hwzz.jpg"\n                    },\n                    {\n                        "id": 320,\n                        "url": "https://res.cloudinary.com/dzbtsco86/image/upload/v1731271447/hotels/file_tudvwn.jpg"\n                    },\n                    {\n                        "id": 321,\n                        "url": "https://res.cloudinary.com/dzbtsco86/image/upload/v1731271448/hotels/file_sxvdoz.jpg"\n                    }\n                ],\n                "rating": 4,\n                "hotelAddress": "Đường Trần Hưng Đạo, TP. Đà Lạt",\n                "hotelId": 191,\n                "hotelName": "Khách Sạn Đà Lạt",\n                "roomAvailable": [\n                    {\n                        "price": 350.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 105,\n                        "roomName": "DL 05",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 450.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 104,\n                        "roomName": "DL 04",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 340.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 103,\n                        "roomName": "DL 03",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 250.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 102,\n                        "roomName": "DL 02",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 400.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 101,\n                        "roomName": "DL 01",\n                        "roomType": "Standard"\n                    }\n                ]\n            },\n            "192": {\n                "hotelPhonenumber": "02633822999",\n                "hotelImages": [],\n                "rating": 4,\n                "hotelAddress": "Đường Nguyễn Văn Cừ, TP. Đà Lạt",\n                "hotelId": 192,\n                "hotelName": "Khách Sạn Ngọc Lan",\n                "roomAvailable": [\n                    {\n                        "price": 1100.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 110,\n                        "roomName": "NL 05",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 400.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 109,\n                        "roomName": "NL 04",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 350.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 108,\n                        "roomName": "NL 03",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 420.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 107,\n                        "roomName": "NL 02",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 380.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 106,\n                        "roomName": "NL 01",\n                        "roomType": "Standard"\n                    }\n                ]\n            },\n            "193": {\n                "hotelPhonenumber": "02633567777",\n                "hotelImages": [],\n                "rating": 4,\n                "hotelAddress": "Đường Phan Bội Châu, TP. Đà Lạt",\n                "hotelId": 193,\n                "hotelName": "Khách Sạn Kỳ Đà",\n                "roomAvailable": [\n                    {\n                        "price": 430.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 115,\n                        "roomName": "KD 05",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 400.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 114,\n                        "roomName": "KD 04",\n                        "roomType": "Superior"\n                    },\n                    {\n                        "price": 350.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 113,\n                        "roomName": "KD 03",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 320.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 112,\n                        "roomName": "KD 02",\n                        "roomType": "Standard"\n                    },\n                    {\n                        "price": 300.00,\n                        "maxPeople": 2,\n                        "availability": true,\n                        "roomId": 111,\n                        "roomName": "KD 01",\n                        "roomType": "Standard"\n                    }\n                ]\n            }\n        },\n        "schedules": {\n            "departure": {\n                "Long Vân Limousine": {\n                    "departureTime": "2024-11-13T05:00:00",\n                    "seatAvailable": [\n                        {\n                            "status": "Empty",\n                            "seat_id": 921,\n                            "seat_number": "A01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 922,\n                            "seat_number": "A02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 923,\n                            "seat_number": "A03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 924,\n                            "seat_number": "A04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 925,\n                            "seat_number": "A05"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 926,\n                            "seat_number": "B01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 927,\n                            "seat_number": "B02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 928,\n                            "seat_number": "B03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 929,\n                            "seat_number": "B04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 930,\n                            "seat_number": "B05"\n                        }\n                    ],\n                    "routeId": "MD-LKH",\n                    "carName": "Long Vân Limousine",\n                    "arrivalTime": "2024-11-13T12:45:00",\n                    "priceForOneSeat": 650.00,\n                    "vehicleCode": "LV001",\n                    "scheduleId": 1072\n                },\n                "Điền Linh Limousine": {\n                    "departureTime": "2024-11-13T00:00:00",\n                    "seatAvailable": [\n                        {\n                            "status": "Empty",\n                            "seat_id": 951,\n                            "seat_number": "A01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 952,\n                            "seat_number": "A02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 953,\n                            "seat_number": "A03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 954,\n                            "seat_number": "A04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 955,\n                            "seat_number": "A05"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 956,\n                            "seat_number": "B01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 957,\n                            "seat_number": "B02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 958,\n                            "seat_number": "B03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 959,\n                            "seat_number": "B04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 960,\n                            "seat_number": "B05"\n                        }\n                    ],\n                    "routeId": "MD-LKH",\n                    "carName": "Điền Linh Limousine",\n                    "arrivalTime": "2024-11-13T06:00:00",\n                    "priceForOneSeat": 210.00,\n                    "vehicleCode": "DL003",\n                    "scheduleId": 1075\n                }\n            },\n            "return": {\n                "Long Vân Limousine": {\n                    "departureTime": "2024-11-14T23:30:00",\n                    "seatAvailable": [\n                        {\n                            "status": "Empty",\n                            "seat_id": 1101,\n                            "seat_number": "A01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1102,\n                            "seat_number": "A02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1103,\n                            "seat_number": "A03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1104,\n                            "seat_number": "A04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1105,\n                            "seat_number": "A05"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1106,\n                            "seat_number": "B01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1107,\n                            "seat_number": "B02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1108,\n                            "seat_number": "B03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1109,\n                            "seat_number": "B04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1110,\n                            "seat_number": "B05"\n                        }\n                    ],\n                    "routeId": "LK-MDONG",\n                    "carName": "Long Vân Limousine",\n                    "arrivalTime": "2024-11-15T07:15:00",\n                    "priceForOneSeat": 450.00,\n                    "vehicleCode": "LV003",\n                    "scheduleId": 1090\n                },\n                "Điền Linh Limousine": {\n                    "departureTime": "2024-11-14T16:35:00",\n                    "seatAvailable": [\n                        {\n                            "status": "Empty",\n                            "seat_id": 1141,\n                            "seat_number": "A01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1142,\n                            "seat_number": "A02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1143,\n                            "seat_number": "A03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1144,\n                            "seat_number": "A04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1145,\n                            "seat_number": "A05"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1146,\n                            "seat_number": "B01"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1147,\n                            "seat_number": "B02"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1148,\n                            "seat_number": "B03"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1149,\n                            "seat_number": "B04"\n                        },\n                        {\n                            "status": "Empty",\n                            "seat_id": 1150,\n                            "seat_number": "B05"\n                        }\n                    ],\n                    "routeId": "LK-MDONG",\n                    "carName": "Điền Linh Limousine",\n                    "arrivalTime": "2024-11-14T22:45:00",\n                    "priceForOneSeat": 210.00,\n                    "vehicleCode": "DL009",\n                    "scheduleId": 1094\n                }\n            }\n        },\n        "checkins": [\n            {\n                "id": 499,\n                "cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n                "name": "Cáp treo Đà Lạt",\n                "address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n                "latitude": 11.946066,\n                "longitude": 108.465760,\n                "payFee": 0.00,\n                "images": null\n            },\n            {\n                "id": 496,\n                "cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n                "name": "Vườn hoa Đà Lạt",\n                "address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n                "latitude": 11.942710,\n                "longitude": 108.445797,\n                "payFee": 0.00,\n                "images": null\n            },\n            {\n                "id": 502,\n                "cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n                "name": "Đồi chè Cầu Đất",\n                "address": "Huyện Xuân Trường, tỉnh Lâm Đồng",\n                "latitude": 11.878500,\n                "longitude": 108.388583,\n                "payFee": 0.00,\n                "images": null\n            },\n            {\n                "id": 500,\n                "cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n                "name": "Chùa Linh Phước",\n                "address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n                "latitude": 11.938444,\n                "longitude": 108.487679,\n                "payFee": 0.00,\n                "images": null\n            },\n            {\n                "id": 497,\n                "cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n                "name": "Trại Mát",\n                "address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n                "latitude": 11.922810,\n                "longitude": 108.467951,\n                "payFee": 0.00,\n                "images": null\n            }\n        ]\n    },\n    "message": ""\n}\n',
          },
        ],
      },
      {
        role: "model",
        parts: [
          {
            text: '```json\n{\n"userData": {\n"location": "Hồ Chí Minh",\n"destination": "Đà Lạt",\n"startDate": "12-11-2024 22:00:00",\n"endDate": "14-11-2024 14:00:00",\n"numberPeople": 2,\n"budget": 2500\n},\n"transportation": {\n"departure": {\n"departureTime": "2024-11-13T00:00:00",\n"seatAvailable": [\n{\n"status": "Empty",\n"seat_id": 951,\n"seat_number": "A01"\n},\n{\n"status": "Empty",\n"seat_id": 952,\n"seat_number": "A02"\n}\n],\n"routeId": "MD-LKH",\n"carName": "Điền Linh Limousine",\n"arrivalTime": "2024-11-13T06:00:00",\n"priceForOneSeat": 210,\n"vehicleCode": "DL003",\n"scheduleId": 1075\n},\n"return": {\n"departureTime": "2024-11-14T16:35:00",\n"seatAvailable": [\n{\n"status": "Empty",\n"seat_id": 1141,\n"seat_number": "A01"\n},\n{\n"status": "Empty",\n"seat_id": 1142,\n"seat_number": "A02"\n}\n],\n"routeId": "LK-MDONG",\n"carName": "Điền Linh Limousine",\n"arrivalTime": "2024-11-14T22:45:00",\n"priceForOneSeat": 210,\n"vehicleCode": "DL009",\n"scheduleId": 1094\n}\n},\n"accomodation": {\n"nameHotel": "Khách Sạn Đà Lạt",\n"hotelId": 191,\n"price_per_night": 250,\n"total": 500,\n"nameRoom": "DL 02",\n"checkin": "2024-11-12",\n"checkout": "2024-11-14",\n"roomType": "Standard",\n"roomId": 102\n},\n"checkins": [\n{\n"id": 499,\n"cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n"name": "Cáp treo Đà Lạt",\n"address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n"latitude": 11.946066,\n"longitude": 108.465760,\n"payFee": 0,\n"images": null\n},\n{\n"id": 496,\n"cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n"name": "Vườn hoa Đà Lạt",\n"address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n"latitude": 11.942710,\n"longitude": 108.445797,\n"payFee": 0,\n"images": null\n},\n{\n"id": 502,\n"cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n"name": "Đồi chè Cầu Đất",\n"address": "Huyện Xuân Trường, tỉnh Lâm Đồng",\n"latitude": 11.878500,\n"longitude": 108.388583,\n"payFee": 0,\n"images": null\n},\n{\n"id": 500,\n"cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n"name": "Chùa Linh Phước",\n"address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n"latitude": 11.938444,\n"longitude": 108.487679,\n"payFee": 0,\n"images": null\n},\n{\n"id": 497,\n"cityName": "Tỉnh Lâm Đồng - Đà Lạt",\n"name": "Trại Mát",\n"address": "Thành phố Đà Lạt, tỉnh Lâm Đồng",\n"latitude": 11.922810,\n"longitude": 108.467951,\n"payFee": 0,\n"images": null\n}\n],\n"estimatedCost": 1120,\n"itinerary": {\n"day1": "2024-11-12: Di chuyển từ Hồ Chí Minh đến Đà Lạt bằng xe Điền Linh Limousine. Nhận phòng tại khách sạn Khách Sạn Đà Lạt. Buổi chiều tham quan Cáp treo Đà Lạt, Vườn hoa Đà Lạt.",\n"day2": "2024-11-13: Tham quan Đồi chè Cầu Đất và Chùa Linh Phước. Buổi chiều tham quan Trại Mát. Di chuyển từ Đà Lạt về Hồ Chí Minh bằng xe Điền Linh Limousine."\n}\n}\n```',
          },
        ],
      },
    ],
  });

  try {
    const result = await chatSession.sendMessage(
      `bạn dựa vào dữ liệu tôi cung cấp chọn ra kế hoạch tốt nhất dựa vào userData của tôi để ý số người từ userData, chọn ra các dịch vụ tối ưu số tiền nhất có thể theo số người nhé, nếu số tiền nhỏ quả thì trả ra json notification: "Không đủ ngân sách để lên kế hoạch", có thể gợi ý có thể giảm cái gì để đủ trong ngân sách đó 
      userData chứa dữ liệu của người dùng (budget là số ngân sách tôi đang để theo dạng phải *1000 nữa mới đúng giá trị thực) ,để ý số người trong chuyến đi để tính toán phù hợp, nếu từ 2 người trở lên hãy tính toán vé xe, 
      tại vé xe tôi cung cấp chỉ là 1 vé 1 người, tính toán thêm vé tham quan ở các nơi check in dựa vào số người, 
      nếu là hotel thì dựa nào numberPeople từ userData mà chọn phòng dựa vào roomSize của room tôi gửi lên, nếu số người nhiều hơn roomSize của phòng bạn có thể chọn thêm 1 phòng nữa,
      nếu numberPeople bằng với roomSize của phòng thì chỉ chọn 1 phòng,
      trả về luôn phòng và id, name, price phòng đó,  các dữ liệu khác là tôi cung cấp, trả về cho tôi theo định dạng json, không thêm bất cứ điều gì khác.
      Chú ý chọn xe dựa vào departure và return, tôi có 2 mảng 1 cái là departute (chuyến đi) chọn chuyến cho departure ở đây, return (chuyến về) chọn chuyến return ở đây. không chọn 2 chuyến return cho departure và return. phải chọn chuyến departure từ dữ liệu departure tôi cung cấp và tương tự cho return. Tuyệt đối không lấy chuyến return cho departure và ngược lại.
      Bạn hãy chọn ghế trong transportation, tôi có để một mảng là seatAvailable chọn ghế từ đây. Trả về theo cú pháp tôi cung cấp như sau.
      userData, transportation(departure (chọn từ mảng schedule.departure mà tôi cung cấp)[departureTime, arrivalTime,vehicleCode,scheduleId,carName, seatBook, routeId, totalPrice(numberPeople*priceForOnSeat) "trả về theo giá tiền việt nam"], 
      return (chọn từ mảng schedule.return mà tôi cung cấp) [departureTime, arrivalTime,vehicleCode,scheduleId,carName, seatBook(seat_id, seat_number), routeId, totalPrice(numberPeople*priceForOnSeat)]),
      accomodation(nameHotel, hotelId, total [tổng giá của các phòng] (trả về theo giá tiền việt nam), (mảng chứa room đã book) rooms[nameRoom, checkin, checkout, roomType, roomId, roomSize(maxPeople),price_per_night]. Chú ý: dựa vào numberPeople chỉ đặt vừa đủ không được dư phòng) , 
      checkins(dựa vào những nơi tôi cung cấp, ít nhất 5 nơi), estimatedCost (trả về theo giá tiền việt nam), itinerary(trả theo ngày, day1, day2,... đi đâu vào ngày làm gì,...), 
      để ý số người mà tính toán cho đúng, nếu không đủ số tiền có thể chọn một nơi ở khác giá rẻ hơn, sau đó nếu vẫn chưa đủ thì chọn chuyến xe khác sẽ hơn, làm sao cho 1 kế hoạch tối ưu chi phí nhất\n\n${JSON.stringify(data)}`
    );
    // const expected = cleanedResponse(result.response.text());
    console.log(result.response.text());
    let cleanedResponse = result.response
      .text()
      .replace(/```json/g, "")
      .replace(/```/g, "")
      // .replace(/\/\/.*$/gm, "")
      // .replace(/\*.*$/gm, "")
      .trim();
    const lastCurlyBraceIndex = cleanedResponse.lastIndexOf("}");
    if (lastCurlyBraceIndex !== -1) {
      cleanedResponse = cleanedResponse.slice(0, lastCurlyBraceIndex + 1);
    }
    console.log(cleanedResponse);
    console.log(JSON.parse(cleanedResponse));
    return JSON.parse(cleanedResponse);
  } catch (error) {
    console.error("An error occurred while sending the message:", error);
    // throw new Error("Failed to generate trip plan");
  }
};

const testData = {
  user_info: {
    current_location: "Hồ Chí Minh",
    destination: "Đà Lạt",
    departure_date: "2024-10-12",
    return_date: "2024-10-14",
    number_of_people: 2,
    budget: 3000000,
  },
  transportation_options: [
    {
      id: 1,
      price: 250000,
      departure_location: "Hồ Chí Minh",
      arrival_location: "Đà Lạt",
      departure_time: "2024-10-12T06:00:00",
      arrival_time: "2024-10-12T12:00:00",
    },
    {
      id: 2,
      price: 250000,
      departure_location: "Đà Lạt",
      arrival_location: "Hồ Chí Minh",
      departure_time: "2024-10-14T14:00:00",
      arrival_time: "2024-10-14T20:00:00",
    },
    {
      id: 3,
      price: 280000,
      departure_location: "Đà Lạt",
      arrival_location: "Hồ Chí Minh",
      departure_time: "2024-10-14T15:00:00",
      arrival_time: "2024-10-14T21:00:00",
    },
    {
      id: 4,
      price: 290000,
      departure_location: "Hồ Chí Minh",
      arrival_location: "Đà Lạt",
      departure_time: "2024-10-12T09:00:00",
      arrival_time: "2024-10-12T15:00:00",
    },
  ],
  hotel_options: [
    {
      id: 1,
      name: "Khách sạn Sunshine",
      price_per_night: 800000,
      total_price: 1600000,
      check_in_date: "2024-10-12",
      check_out_date: "2024-10-14",
    },
    {
      id: 2,
      name: "Homestay Dalat",
      price_per_night: 600000,
      total_price: 1200000,
      check_in_date: "2024-10-12",
      check_out_date: "2024-10-14",
    },
  ],
  checkin_point_options: [
    {
      id: 1,
      name: "Thung lũng Tình Yêu",
      price: 40000,
    },
    {
      id: 2,
      name: "Hồ Xuân Hương",
      price: 20000,
    },
    {
      id: 3,
      name: "Chùa Linh Phước",
      price: 50000,
    },
    {
      id: 4,
      name: "Đồi Mộng Mơ",
      price: 30000,
    },
    {
      id: 5,
      name: "Vườn hoa Thành phố Đà Lạt",
      price: 30000,
    },
    {
      id: 6,
      name: "Ga Đà Lạt",
      price: 20000,
    },
  ],
};
